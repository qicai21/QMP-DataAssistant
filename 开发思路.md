# 一、插件功能流程

1. 用户上传 Excel 文件，该 Excel 包含箱号、箱子重量、收货时间等信息。插件获取 Excel 内容。

[x] 已经完成，可以顺利读取数据。

2. 向服务器发送请求，下载当前 document ID 下的数据，数据包含发货时间、箱号、tp-id 等信息。

[x] 重构整个项目，将background.js中的获取documentGuid、cookie、authorization的功能，放到popup中。
[ ] popup.html上应该有这些功能：
    - 上传文件并读取到变量中，
    - 页面每次弹出就重新刷新，
    - 匹配数据按钮（如果上传的数据、documentGuid、cookie、authorization缺少，则匹配数据按钮不亮），匹配完成后将弹出一个页面，显示匹配的结果，有一个确认按钮。
    - 同步按钮，同步之后显示同步成功。

1. 将用户上传 Excel 里箱号与服务器数据按箱号进行匹配
    - 找到收货重量为0的数据；
    - 按箱号将服务器数据的 tpid进行补全,若服务器上某箱号对应记录只有一条，自动添加 tpid 等信息。
    - 由于箱子循环使用，海关系统抓取的数据中，箱号可能对应多条记录（每条记录有唯一 tpid），1配多时需要弹出页面让用户进行选择，这里弹出的需要有发货时间和发货重量。
  
2. 匹配完成后，形成包含箱号、tpid、收货重量、收货时间等齐全信息的数据表。

3. 调用插件内方法，将该数据表数据进行上传，并显示全部上传后的结果和状态。

# 二、技术测试要点

**Excel 读取测试**：测试在插件内能否顺利读取用户上传 Excel 的全部内容。

**数据获取测试**：从海关系统上下载数据，并形成表格（或json）。

**数据匹配测试**：对用户下载服务器数据后的匹配情况进行测试。

# 三、已完成功能

逐条数据上传功能已完成开发且测试通过，可实现重新上传。

```javascript
const data = {
    COMPLETE_RECEIVE_DESC: "",
    RECEIVE_DESC: "",
    WEIGHT: 8880,
    ReceiveDate: "2025-03-28 10:16:0",
    TRANS_DETAIL_GUID: "bee2a731-97f3-4349-a908-87d9ce4bcd15",
    DOCUMENT_GUID: "5c7410d3-c275-461c-bf1b-6d670b56fb39"
}

const formData = new URLSearchParams();
for (const [key, value] of Object.entries(data)) {
    formData.append(key, value);
}

const authStr = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpbmZvIjp7IlVJRCI6IkNFRThFMDE2RDY0MEFFOENDRjUyRTUwRjU1MTAwN0U1IiwiRW50VHlwZSI6IkdyYWluIiwiUmVnaXN0ZXJEYXRlIjoiMjAyMi0wMi0yMyAxMTozNToxOC45MDciLCJVc2VyTmFtZSI6IjIxMDAwMDEyMDAwMDExIiwiRGlzcGxheU5hbWUiOiLmnY7lh68iLCJDb3JyZXBOYW1lIjoi5Y-y5rSq5paMIiwiRW1haWwiOiJqaXVzYW50aWVsaW5nQDE2My5jb20iLCJNb2JpbGVQaG9uZSI6IjE5OTY5OTM3NjY1IiwiRW50T3JnQ29kZSI6IjkxMjExMjIxNjczNzYxNTVYSCIsIkVudE5hbWUiOiLkuZ3kuInpm4blm6Lpk4Hlsq3lpKfosYbnp5HmioDmnInpmZDlhazlj7giLCJFbnROYW1lU3lzIjoi5Lmd5LiJ6ZuG5Zui6ZOB5bKt5aSn6LGG56eR5oqA5pyJ6ZmQ5YWs5Y-4IiwiRW50R3VpZCI6ImE1NmY2ZmExLWM2YzYtNGRlYy1iYjRhLTQyZWYxMzA4YTkyNiIsIk9yZ0NvZGUiOiIyNDY0MDAiLCJPcmdOYW1lIjoi6ZOB5bKt5rW35YWz5pys6YOoIiwic3ciOjAsImRhZG91IjowLCJmdHkiOjEsInRlcm1pbmFsIjowLCJtYXRvdSI6MCwiamlua291IjoxfSwiZXhwIjoxNzQzOTA2ODQwLjA5Mjc2NDR9.D4HPgTKCjje9oaA-xVln-ilbYhWlqw_hGyz2ti7O8_s'

const options = {
    method: 'POST',
    headers: {
        'authorization': authStr,
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
        'x-requested-with': 'XMLHttpRequest'
    },
    credentials: 'include',
    body: formData.toString()
};

fetch('http://apq.customs.gov.cn/webapi/ent/Process/StockInConfirm/receive/update/A', options)
   .then(response => response.json()) // 如果接口返回 JSON 数据，解析它
   .then(data => console.log(data)) // 打印响应数据
   .catch(error => console.error('Error:', error));
```
